<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEATH NOTE Killer Within 捜査メモ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --top-bar-height: 60px; 
            --bottom-bar-height: 70px; 
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #6366f1;
            --accent: #8b5cf6;
            --surface: #1e293b;
            --surface-elevated: #334155;
            --border: #475569;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        .main-content {
            margin-top: calc(var(--top-bar-height) + 1rem);
            margin-bottom: calc(var(--bottom-bar-height) + 1rem);
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .glass-button {
            background: rgba(79, 70, 229, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-button:hover {
            background: rgba(67, 56, 202, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }
        .graph-container {
            width: 100%;
            height: 450px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 1rem;
            touch-action: none;
            cursor: move;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(12px);
        }
        .node circle { 
            stroke: #e2e8f0; 
            stroke-width: 3px; 
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        .node text { 
            font-size: 22px; 
            font-weight: bold; 
            fill: #f7fafc; 
            text-anchor: middle; 
            pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }
        .candidate-btn {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background: rgba(71, 85, 105, 0.8);
            backdrop-filter: blur(8px);
            color: #cbd5e1;
            border: 2px solid rgba(71, 85, 105, 0.3);
            font-weight: 600;
            font-size: 1rem;
            min-width: 3rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .candidate-btn:hover {
            background: rgba(79, 70, 229, 0.6);
            border-color: rgba(79, 70, 229, 0.5);
            transform: translateY(-1px);
        }
        .candidate-btn.selected-l {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .candidate-btn.selected-kira {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        .link { stroke-opacity: 0.9; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .link.white { stroke: #60a5fa; stroke-width: 4px; }
        .link.black { stroke: #f87171; stroke-width: 4px; }
        select, input[type="text"], input[type="number"] { 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none;
            background: rgba(51, 65, 85, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            transition: all 0.3s ease;
        }
        select:focus, input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .radio-label span { 
            padding: 0.5rem 1rem; 
            border-radius: 0.75rem; 
            background: rgba(71, 85, 105, 0.8);
            backdrop-filter: blur(8px);
            color: #cbd5e1; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        .radio-label input:checked + span { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; 
            font-weight: 600;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        #tooltip { 
            position: absolute; 
            visibility: hidden; 
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            color: white; 
            padding: 8px 12px; 
            border-radius: 8px; 
            pointer-events: none; 
            transition: all 0.2s ease; 
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
            font-weight: 500;
        }
        .top-bar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: var(--top-bar-height); 
            z-index: 50;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        .bottom-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: var(--bottom-bar-height); 
            z-index: 50;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }
        .bottom-bar a {
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .bottom-bar a:hover {
            background: rgba(79, 70, 229, 0.2);
            transform: translateY(-2px);
        }
        .date-checkbox-label span { 
            display: block; 
            padding: 0.75rem 1rem; 
            border-radius: 0.75rem; 
            background: rgba(71, 85, 105, 0.8);
            backdrop-filter: blur(8px);
            color: #cbd5e1; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer; 
            text-align: center;
            border: 1px solid rgba(71, 85, 105, 0.3);
            font-weight: 500;
        }
        .date-checkbox-label input:checked + span { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; 
            font-weight: 600;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        .section-header {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
            margin: -1rem -1rem 1rem -1rem;
            padding: 1.5rem;
            border-radius: 0.75rem 0.75rem 0 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        .history-item {
            background: rgba(51, 65, 85, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.3s ease;
        }
        .history-item:hover {
            background: rgba(51, 65, 85, 0.8);
            transform: translateX(4px);
        }
        .zoom-controls {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 1rem;
            padding: 0.5rem;
        }
        .floating-header {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="text-white antialiased">

    <div id="tooltip"></div>

    <!-- Top Bar -->
    <div id="top-bar" class="top-bar flex items-center justify-end px-6">
        <div class="flex items-center gap-3">
            <label for="recording-day-select" class="font-semibold text-gray-300">記録日:</label>
            <select id="recording-day-select" class="rounded-lg p-2 text-white focus:ring-2 focus:ring-indigo-500 font-medium"></select>
            <button id="add-day-btn" class="glass-button text-white font-bold w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-lg">+</button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content max-w-5xl mx-auto px-4">
        <header class="text-center mb-8 floating-header rounded-2xl p-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-100 mb-3 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">DEATH NOTE Killer Within 捜査メモ</h1>
            <p class="text-gray-400 text-lg">会議の情報を整理し、キラを追い詰めよう</p>
        </header>

        <div id="section-rules" class="glass-card rounded-2xl shadow-2xl mb-8">
            <div class="p-6">
                <div class="section-header">
                    <h2 class="text-2xl font-bold text-gray-100">ルール設定</h2>
                </div>
                <div class="space-y-6">
                    <!-- ゲーム設定 -->
                    <div>
                        <h3 class="text-lg font-bold text-red-400 mb-4 border-b border-red-400/30 pb-2">ゲーム設定</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">身分証取得</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl"><label class="radio-label"><input type="radio" name="id-theft" value="off" checked class="hidden"><span>OFF</span></label><label class="radio-label"><input type="radio" name="id-theft" value="on" class="hidden"><span>ON</span></label></div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">全員デスノートを開く</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl"><label class="radio-label"><input type="radio" name="dn-open" value="off" checked class="hidden"><span>OFF</span></label><label class="radio-label"><input type="radio" name="dn-open" value="on" class="hidden"><span>ON</span></label></div>
                            </div>
                        </div>
                    </div>

                    <!-- 基本役職 -->
                    <div>
                        <h3 class="text-lg font-bold text-red-400 mb-4 border-b border-red-400/30 pb-2">基本役職</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">L枠</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap"><label class="radio-label"><input type="radio" name="l-role" value="l" class="hidden"><span>L</span></label><label class="radio-label"><input type="radio" name="l-role" value="near" class="hidden"><span>ニア</span></label><label class="radio-label"><input type="radio" name="l-role" value="random" checked class="hidden"><span>ランダム</span></label></div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">キラ枠</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap"><label class="radio-label"><input type="radio" name="kira-role" value="kira" class="hidden"><span>キラ</span></label><label class="radio-label"><input type="radio" name="kira-role" value="x-kira" class="hidden"><span>Xキラ</span></label><label class="radio-label"><input type="radio" name="kira-role" value="random" checked class="hidden"><span>ランダム</span></label></div>
                            </div>
                        </div>
                    </div>

                    <!-- 追加役職 -->
                    <div>
                        <h3 class="text-lg font-bold text-red-400 mb-4 border-b border-red-400/30 pb-2">追加役職</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end mb-6">
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">キラ信者</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap">
                                    <label class="radio-label"><input type="radio" name="believer-count" value="off" checked class="hidden"><span>なし</span></label>
                                    <label class="radio-label"><input type="radio" name="believer-count" value="1" class="hidden"><span>1人</span></label>
                                    <label class="radio-label"><input type="radio" name="believer-count" value="random" class="hidden"><span>ランダム</span></label>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <h4 class="font-semibold text-gray-300 mb-3">キラ信者種類</h4>
                                <div id="believer-role-container" class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap opacity-50">
                                    <label class="radio-label"><input type="radio" name="believer-role" value="believer" class="hidden" disabled><span>キラ信者</span></label>
                                    <label class="radio-label"><input type="radio" name="believer-role" value="spokesperson" checked class="hidden" disabled><span>キラの代弁者</span></label>
                                    <label class="radio-label"><input type="radio" name="believer-role" value="random" class="hidden" disabled><span>ランダム</span></label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">メロ</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap"><label class="radio-label"><input type="radio" name="mello-role" value="off" class="hidden"><span>なし</span></label><label class="radio-label"><input type="radio" name="mello-role" value="on" checked class="hidden"><span>1人</span></label><label class="radio-label"><input type="radio" name="mello-role" value="random" class="hidden"><span>ランダム</span></label></div>
                            </div>
                            <div class="md:col-start-1">
                                <h4 class="font-semibold text-gray-300 mb-3">ワタリ</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap"><label class="radio-label"><input type="radio" name="watari-role" value="off" class="hidden"><span>なし</span></label><label class="radio-label"><input type="radio" name="watari-role" value="on" checked class="hidden"><span>1人</span></label><label class="radio-label"><input type="radio" name="watari-role" value="random" class="hidden"><span>ランダム</span></label></div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-3">局長</h4>
                                <div class="flex items-center glass-card p-3 rounded-xl gap-2 flex-wrap"><label class="radio-label"><input type="radio" name="director-role" value="off" class="hidden"><span>なし</span></label><label class="radio-label"><input type="radio" name="director-role" value="on" checked class="hidden"><span>1人</span></label><label class="radio-label"><input type="radio" name="director-role" value="random" class="hidden"><span>ランダム</span></label></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-events" class="glass-card rounded-2xl shadow-2xl mb-8">
            <div class="p-6">
                <div class="section-header">
                    <h2 class="text-2xl font-bold text-gray-100">イベント記録</h2>
                    <p class="text-sm text-gray-400 mt-2">記録日: Day <span id="event-recording-day">1</span></p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">共同タスク</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                            <select id="joint-task-player1" class="w-full rounded-lg p-3 text-white font-medium"></select>
                            <select id="joint-task-player2" class="w-full rounded-lg p-3 text-white font-medium"></select>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium">進捗:</label>
                            <input type="number" id="joint-task-progress" min="0" max="3" value="0" class="flex-1 rounded-lg p-3 text-white text-center font-medium">
                            <button id="set-joint-task" class="flex-1 glass-button text-white font-bold py-3 px-4 rounded-lg">記録</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">吊り記録</h3>
                        <div class="space-y-3">
                            <select id="executed-player-select" class="w-full rounded-lg p-3 text-white font-medium"></select>
                            <select id="execution-result-select" class="w-full rounded-lg p-3 text-white font-medium">
                                <option value="怪しいアイテム無し">怪しいアイテム無し</option>
                                <option value="他人の身分証">他人の身分証</option>
                                <option value="キラカード">キラカード</option>
                            </select>
                            <div id="arrester-container" class="hidden">
                                <label for="arrester-select" class="block text-sm font-semibold mb-2">逮捕者:</label>
                                <select id="arrester-select" class="w-full rounded-lg p-3 text-white font-medium"></select>
                            </div>
                            <button id="record-execution" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02]">記録</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">殺害記録</h3>
                        <select id="murdered-player-select" class="w-full rounded-lg p-3 text-white font-medium mb-4"></select>
                        <button id="record-murder" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02]">記録</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-testimony" class="glass-card rounded-2xl shadow-2xl mb-8">
            <div class="p-6">
                <div class="section-header">
                    <h2 class="text-2xl font-bold text-gray-100">証言と役職</h2>
                    <p class="text-sm text-gray-400 mt-2">記録日: Day <span id="testimony-recording-day">1</span></p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">証言</h3>
                        <div class="flex flex-col sm:flex-row gap-3 items-center mb-4">
                            <select id="source-select" class="flex-1 w-full rounded-lg p-3 text-white font-medium"></select>
                            <span class="text-gray-400 font-medium">が</span>
                            <select id="target-select" class="flex-1 w-full rounded-lg p-3 text-white font-medium"></select>
                            <span class="text-gray-400 font-medium">に</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="add-white" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02]">白出し</button>
                            <button id="add-black" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02]">黒出し</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">役職確定</h3>
                        <div class="flex flex-col sm:flex-row gap-3 items-center mb-4">
                            <select id="player-role-select" class="flex-1 w-full rounded-lg p-3 text-white font-medium"></select>
                            <select id="role-select" class="flex-1 w-full rounded-lg p-3 text-white font-medium">
                                <option value="Undetermined">未確定</option>
                                <option value="Kira-Believer">キラ信者</option>
                                <option value="L">L</option>
                                <option value="Investigator">捜査員</option>
                                <option value="Mello">メロ</option>
                                <option value="Watari">ワタリ</option>
                                <option value="Director">局長</option>
                            </select>
                        </div>
                        <button id="set-role" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02]">確定</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="section-graph" class="glass-card rounded-2xl shadow-2xl mb-8">
            <div class="p-6">
                <div class="section-header">
                    <h2 class="text-2xl font-bold text-gray-100">捜査状況</h2>
                </div>
                <div class="flex items-center justify-center gap-3 my-4 flex-wrap">
                    <label class="font-semibold text-gray-300">表示日:</label>
                    <div id="day-checkbox-filter" class="flex items-center gap-2 flex-wrap">
                        <label class="date-checkbox-label"><input type="checkbox" name="day-filter" value="all" checked class="hidden"><span>All</span></label>
                    </div>
                </div>
                <div id="graph" class="graph-container mb-4 relative">
                    <!-- Zoom controls inside graph -->
                    <div class="absolute top-4 right-4 z-10">
                        <div class="flex flex-col gap-2">
                            <button id="zoom-in" class="w-10 h-10 glass-button text-white font-bold rounded-full flex items-center justify-center text-lg shadow-lg">+</button>
                            <button id="zoom-out" class="w-10 h-10 glass-button text-white font-bold rounded-full flex items-center justify-center text-lg shadow-lg">−</button>
                            <button id="zoom-reset" class="w-10 h-10 glass-button text-white font-bold rounded-full flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.621m15.379 0V4m-.621 0h.621m-15.379 0H4m15.621 16v-5h-.621m-15.379 0V20m.621 0H4m15.379 0h.621"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-memo" class="glass-card rounded-2xl shadow-2xl mb-8">
            <div class="p-6">
                <div class="section-header">
                    <h2 class="text-2xl font-bold text-gray-100">簡易メモ</h2>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">L候補</h3>
                        <div class="flex flex-wrap gap-2" id="l-candidates">
                            <button class="candidate-btn" data-candidate="A" data-type="l">A</button>
                            <button class="candidate-btn" data-candidate="B" data-type="l">B</button>
                            <button class="candidate-btn" data-candidate="C" data-type="l">C</button>
                            <button class="candidate-btn" data-candidate="D" data-type="l">D</button>
                            <button class="candidate-btn" data-candidate="E" data-type="l">E</button>
                            <button class="candidate-btn" data-candidate="F" data-type="l">F</button>
                            <button class="candidate-btn" data-candidate="G" data-type="l">G</button>
                            <button class="candidate-btn" data-candidate="H" data-type="l">H</button>
                            <button class="candidate-btn" data-candidate="I" data-type="l">I</button>
                            <button class="candidate-btn" data-candidate="J" data-type="l">J</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">キラ候補</h3>
                        <div class="flex flex-wrap gap-2" id="kira-candidates">
                            <button class="candidate-btn" data-candidate="A" data-type="kira">A</button>
                            <button class="candidate-btn" data-candidate="B" data-type="kira">B</button>
                            <button class="candidate-btn" data-candidate="C" data-type="kira">C</button>
                            <button class="candidate-btn" data-candidate="D" data-type="kira">D</button>
                            <button class="candidate-btn" data-candidate="E" data-type="kira">E</button>
                            <button class="candidate-btn" data-candidate="F" data-type="kira">F</button>
                            <button class="candidate-btn" data-candidate="G" data-type="kira">G</button>
                            <button class="candidate-btn" data-candidate="H" data-type="kira">H</button>
                            <button class="candidate-btn" data-candidate="I" data-type="kira">I</button>
                            <button class="candidate-btn" data-candidate="J" data-type="kira">J</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-history" class="glass-card rounded-2xl shadow-2xl">
            <div class="p-6">
                <div class="section-header">
                    <h2 class="text-2xl font-bold text-gray-100">記録履歴</h2>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">役職確定</h3>
                        <div id="role-history-list" class="space-y-3 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">共同タスク</h3>
                        <div id="task-history-list" class="space-y-3 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">吊り・殺害</h3>
                        <div id="event-history-list" class="space-y-3 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">証言</h3>
                        <div id="testimony-history-list" class="space-y-3 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar flex items-center justify-around text-gray-300">
        <a href="#section-rules" class="nav-link text-center hover:text-white transition-colors">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span class="text-xs font-medium">ルール</span>
        </a>
        <a href="#section-events" class="nav-link text-center hover:text-white transition-colors">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <span class="text-xs font-medium">イベント</span>
        </a>
        <a href="#section-testimony" class="nav-link text-center hover:text-white transition-colors">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            <span class="text-xs font-medium">証言</span>
        </a>
        <a href="#section-graph" class="nav-link text-center hover:text-white transition-colors">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <span class="text-xs font-medium">捜査状況</span>
        </a>
        <a href="#section-memo" class="nav-link text-center hover:text-white transition-colors">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            <span class="text-xs font-medium">メモ</span>
        </a>
        <a href="#section-history" class="nav-link text-center hover:text-white transition-colors">
             <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg>
            <span class="text-xs font-medium">履歴</span>
        </a>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure page starts at the top
        window.scrollTo(0, 0);
        
        // Data store
        const playerIds = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
        const nodes = playerIds.map(id => ({ id, name: id, role: 'Undetermined' }));
        let links = [];
        let nextLinkId = 0;
        let jointTasks = {};
        let roleHistory = [];
        let executions = {};
        let murders = {};
        let displayDays = ['all'];
        let recordingDay = '1';
        let availableDays = ['1', '2', '3', '4', '5'];
        let lCandidates = new Set();
        let kiraCandidates = new Set();

        // Role definitions
        const roleNames = { 'Undetermined': '未確定', 'Kira-Believer': 'キラ信者', 'L': 'L', 'Investigator': '捜査員', 'Mello': 'メロ', 'Watari': 'ワタリ', 'Director': '局長',};
        const roleColors = { 'Undetermined': '#64748b', 'Kira-Believer': '#ef4444', 'L': '#3b82f6', 'Investigator': '#22c55e', 'Mello': '#a855f7', 'Watari': '#4ade80', 'Director': '#38bdf8',};

        // DOM Elements
        const sourceSelect = document.getElementById('source-select');
        const targetSelect = document.getElementById('target-select');
        const playerRoleSelect = document.getElementById('player-role-select');
        const jointTaskPlayer1Select = document.getElementById('joint-task-player1');
        const jointTaskPlayer2Select = document.getElementById('joint-task-player2');
        const jointTaskProgressInput = document.getElementById('joint-task-progress');
        const dayCheckboxFilter = document.getElementById('day-checkbox-filter');
        const recordingDaySelect = document.getElementById('recording-day-select');
        const executedPlayerSelect = document.getElementById('executed-player-select');
        const executionResultSelect = document.getElementById('execution-result-select');
        const arresterContainer = document.getElementById('arrester-container');
        const arresterSelect = document.getElementById('arrester-select');
        const murderedPlayerSelect = document.getElementById('murdered-player-select');
        const tooltip = d3.select("#tooltip");
        const addDayBtn = document.getElementById('add-day-btn');
        const eventRecordingDaySpan = document.getElementById('event-recording-day');
        const testimonyRecordingDaySpan = document.getElementById('testimony-recording-day');

        function updateDaySelectors() {
            const currentRecordingDay = recordingDaySelect.value;
            recordingDaySelect.innerHTML = '';
            availableDays.forEach(day => {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = `Day ${day}`;
                recordingDaySelect.appendChild(option);
            });
            
            if (availableDays.includes(currentRecordingDay)) {
                recordingDaySelect.value = currentRecordingDay;
            } else {
                recordingDaySelect.value = availableDays.length > 0 ? availableDays[0] : '1';
            }
            recordingDay = recordingDaySelect.value || '1';
            eventRecordingDaySpan.textContent = recordingDay;
            testimonyRecordingDaySpan.textContent = recordingDay;

            const currentDisplayDays = Array.from(document.querySelectorAll('#day-checkbox-filter input[name="day-filter"]:checked')).map(cb => cb.value);
            dayCheckboxFilter.innerHTML = '<label class="date-checkbox-label"><input type="checkbox" name="day-filter" value="all" class="hidden"><span>All</span></label>';
            availableDays.forEach(day => {
                const label = document.createElement('label');
                label.className = 'date-checkbox-label';
                label.innerHTML = `<input type="checkbox" name="day-filter" value="${day}" class="hidden"><span>${day}</span>`;
                dayCheckboxFilter.appendChild(label);
            });
            
            if (currentDisplayDays.includes('all')) {
                 dayCheckboxFilter.querySelector('input[value="all"]').checked = true;
            } else {
                currentDisplayDays.forEach(day => {
                    const cb = dayCheckboxFilter.querySelector(`input[value="${day}"]`);
                    if (cb) cb.checked = true;
                });
            }
             if (dayCheckboxFilter.querySelectorAll('input:checked').length === 0) {
                 dayCheckboxFilter.querySelector('input[value="all"]').checked = true;
             }
        }

        function updateSelections() {
             const selects = [sourceSelect, targetSelect, playerRoleSelect, jointTaskPlayer1Select, jointTaskPlayer2Select, executedPlayerSelect, murderedPlayerSelect, arresterSelect];
             selects.forEach(s => { 
                 if(s) {
                    const currentValue = s.value;
                    s.innerHTML = ''; 
                    nodes.forEach(node => {
                        const option = document.createElement('option');
                        option.value = node.id;
                        option.textContent = node.id;
                        s.appendChild(option.cloneNode(true));
                    });
                    if (Array.from(s.options).some(o => o.value === currentValue)) {
                        s.value = currentValue;
                    }
                 }
            });
        }
        
        updateDaySelectors();
        updateSelections();

        // D3 Setup
        const container = document.getElementById('graph');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const svg = d3.select("#graph").append("svg").attr("width", width).attr("height", height).attr("viewBox", [0, 0, width, height]);
        
        // Define arrow markers with proper configuration
        const defs = svg.append("defs");
        
        // White arrow marker
        defs.append("marker")
            .attr("id", "arrow-white")
            .attr("viewBox", "0 0 10 10")
            .attr("refX", 9)
            .attr("refY", 3)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M 0 0 L 10 3 L 0 6 z")
            .style("fill", "#60a5fa");
            
        // Black arrow marker  
        defs.append("marker")
            .attr("id", "arrow-black")
            .attr("viewBox", "0 0 10 10")
            .attr("refX", 9)
            .attr("refY", 3)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M 0 0 L 10 3 L 0 6 z")
            .style("fill", "#f87171");
        const g = svg.append("g");
        let link = g.append("g").attr("class", "links").selectAll(".link");
        let node = g.append("g").attr("class", "nodes").selectAll(".node");
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(50))
            .on("tick", ticked);
        const zoom = d3.zoom().scaleExtent([0.3, 3]).on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        function updateGraph() {
            displayDays = Array.from(document.querySelectorAll('#day-checkbox-filter input[name="day-filter"]:checked')).map(cb => cb.value);
            const filteredLinks = displayDays.includes('all') ? links : links.filter(l => displayDays.includes(l.day.toString()));
            const deadPlayerIds = new Set();
            Object.values(executions).forEach(e => { if (e.result !== '怪しいアイテム無し') { deadPlayerIds.add(e.playerId); } });
            Object.values(murders).forEach(m => deadPlayerIds.add(m.playerId));
            
            node = node.data(nodes, d => d.id);
            node.exit().remove();
            const nodeEnter = node.enter().append("g").attr("class", "node");
            nodeEnter.append("circle").attr("r", 40).call(drag(simulation));
            nodeEnter.append("text").attr("dy", ".35em").text(d => d.id);
            node = nodeEnter.merge(node);
            
            node.select("circle").attr("fill", d => roleColors[d.role]);
            node.style("opacity", d => deadPlayerIds.has(d.id) ? 0.4 : 1);
            node.select("text").style("text-decoration", d => deadPlayerIds.has(d.id) ? "line-through" : "none");
            node.on("mouseover", (event, d) => { tooltip.style("visibility", "visible").text(`${d.name}: ${roleNames[d.role]}`);}).on("mousemove", (event) => { tooltip.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px");}).on("mouseout", () => { tooltip.style("visibility", "hidden");});
            
            link = link.data(filteredLinks, d => d.id);
            link.exit().remove();
            const linkEnter = link.enter().append("line")
                .attr("class", d => `link ${d.type}`)
                .attr("stroke-width", 3)
                .attr("stroke", d => d.type === 'white' ? '#60a5fa' : '#f87171')
                .attr("stroke-opacity", 0.9);
                
            link = linkEnter.merge(link);
            
            // Apply marker-end to all links
            link.attr("marker-end", d => `url(#arrow-${d.type})`)
                .attr("stroke", d => d.type === 'white' ? '#60a5fa' : '#f87171');

            simulation.nodes(nodes);
            simulation.force("link").links(filteredLinks);
            simulation.alpha(0.3).restart();
        }

        function ticked() {
            // Calculate link positions with proper offset for arrows
            link.each(function(d) {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                if (length > 0) {
                    // Calculate offset to stop line at edge of target node (radius 40)
                    const offsetX = (dx / length) * 40;
                    const offsetY = (dy / length) * 40;
                    
                    d3.select(this)
                        .attr("x1", d.source.x)
                        .attr("y1", d.source.y)
                        .attr("x2", d.target.x - offsetX)
                        .attr("y2", d.target.y - offsetY);
                }
            });
            
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        }
        
        function drag(simulation) {
            function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
            return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        }

        // Event Listeners & Handlers
        addDayBtn.addEventListener('click', () => {
            const nextDay = (availableDays.length + 1).toString();
            availableDays.push(nextDay);
            updateDaySelectors();
        });
        document.getElementById('add-white').addEventListener('click', () => addLink('white'));
        document.getElementById('add-black').addEventListener('click', () => addLink('black'));
        document.getElementById('set-role').addEventListener('click', setRole);
        document.getElementById('set-joint-task').addEventListener('click', recordJointTask);
        document.getElementById('record-execution').addEventListener('click', recordExecution);
        document.getElementById('record-murder').addEventListener('click', recordMurder);
        document.getElementById('zoom-in').addEventListener('click', () => svg.transition().duration(250).call(zoom.scaleBy, 1.5));
        document.getElementById('zoom-out').addEventListener('click', () => svg.transition().duration(250).call(zoom.scaleBy, 0.67));
        document.getElementById('zoom-reset').addEventListener('click', () => {
            // Calculate bounds to fit all nodes
            const nodeBounds = {
                x: d3.extent(nodes, d => d.x || 0),
                y: d3.extent(nodes, d => d.y || 0)
            };
            
            const dx = nodeBounds.x[1] - nodeBounds.x[0] + 120; // Add padding
            const dy = nodeBounds.y[1] - nodeBounds.y[0] + 120; // Add padding
            const x = (nodeBounds.x[0] + nodeBounds.x[1]) / 2;
            const y = (nodeBounds.y[0] + nodeBounds.y[1]) / 2;
            
            const scale = Math.max(0.3, Math.min(3, 0.8 / Math.max(dx / width, dy / height)));
            const translate = [width / 2 - scale * x, height / 2 - scale * y];
            
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        });
        
        recordingDaySelect.addEventListener('change', e => { 
            recordingDay = e.target.value; 
            eventRecordingDaySpan.textContent = recordingDay;
            testimonyRecordingDaySpan.textContent = recordingDay;
        });
        executionResultSelect.addEventListener('change', e => arresterContainer.classList.toggle('hidden', e.target.value === '怪しいアイテム無し'));

        dayCheckboxFilter.addEventListener('change', (e) => {
            if (e.target.value === 'all') {
                const isChecked = e.target.checked;
                dayCheckboxFilter.querySelectorAll('input').forEach(cb => cb.checked = isChecked);
            } else {
                dayCheckboxFilter.querySelector('input[value="all"]').checked = false;
            }
            if (dayCheckboxFilter.querySelectorAll('input:checked').length === 0) {
                 dayCheckboxFilter.querySelector('input[value="all"]').checked = true;
            }
            if(dayCheckboxFilter.querySelectorAll('input:not([value="all"]):checked').length === availableDays.length) {
                dayCheckboxFilter.querySelectorAll('input').forEach(cb => cb.checked = true);
            }
            updateGraph();
        });
        
        document.querySelectorAll('input[name="believer-count"]').forEach(radio => {
            radio.addEventListener('change', event => {
                const value = event.target.value;
                const believerRoleContainer = document.getElementById('believer-role-container');
                const believerRoleRadios = believerRoleContainer.querySelectorAll('input[name="believer-role"]');
                
                if (value !== 'off') {
                    believerRoleContainer.classList.remove('opacity-50');
                    believerRoleRadios.forEach(r => r.disabled = false);
                } else {
                    believerRoleContainer.classList.add('opacity-50');
                    believerRoleRadios.forEach(r => r.disabled = true);
                }
            });
        });

        // Memo functionality
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('candidate-btn')) {
                const candidate = e.target.dataset.candidate;
                const type = e.target.dataset.type;
                
                if (type === 'l') {
                    if (lCandidates.has(candidate)) {
                        lCandidates.delete(candidate);
                        e.target.classList.remove('selected-l');
                    } else {
                        lCandidates.add(candidate);
                        e.target.classList.add('selected-l');
                    }
                } else if (type === 'kira') {
                    if (kiraCandidates.has(candidate)) {
                        kiraCandidates.delete(candidate);
                        e.target.classList.remove('selected-kira');
                    } else {
                        kiraCandidates.add(candidate);
                        e.target.classList.add('selected-kira');
                    }
                }
            }
        });

        // Smooth scroll navigation with top bar offset
        document.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (link && link.getAttribute('href').startsWith('#')) {
                e.preventDefault();
                const targetId = link.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                
                if (targetElement) {
                    const topBarHeight = document.getElementById('top-bar').offsetHeight;
                    const targetPosition = targetElement.offsetTop - topBarHeight - 16; // 16px additional margin
                    
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }
            }
        });

        function addLink(type) {
            links.push({ id: nextLinkId++, source: sourceSelect.value, target: targetSelect.value, type, day: recordingDay });
            updateGraph(); updateHistoryView();
        }
        function setRole() {
            const node = nodes.find(n => n.id === playerRoleSelect.value);
            if (node) {
                node.role = document.getElementById('role-select').value;
                roleHistory = roleHistory.filter(r => r.playerId !== node.id);
                if (node.role !== 'Undetermined') roleHistory.push({ playerId: node.id, role: node.role });
                updateGraph(); updateHistoryView();
            }
        }
        function recordJointTask() {
            jointTasks[recordingDay] = { p1: jointTaskPlayer1Select.value, p2: jointTaskPlayer2Select.value, progress: jointTaskProgressInput.value };
            updateHistoryView();
        }
        function recordExecution() {
            const result = executionResultSelect.value;
            executions[recordingDay] = { playerId: executedPlayerSelect.value, result, arresterId: (result !== '怪しいアイテム無し' ? arresterSelect.value : null) };
            updateGraph(); updateHistoryView();
        }
        function recordMurder() {
            murders[recordingDay] = { playerId: murderedPlayerSelect.value };
            updateGraph(); updateHistoryView();
        }
        
        function updateHistoryView() {
            const rh = document.getElementById('role-history-list');
            const th = document.getElementById('task-history-list');
            const teh = document.getElementById('testimony-history-list');
            const eh = document.getElementById('event-history-list');
            rh.innerHTML = th.innerHTML = teh.innerHTML = eh.innerHTML = '';
            
            const createPlaceholder = () => '<p class="text-gray-400">履歴はありません</p>';

            if (roleHistory.length === 0) { rh.innerHTML = createPlaceholder(); } 
            else { roleHistory.forEach(hist => { rh.innerHTML += `<div class="history-item flex justify-between items-center p-3 rounded-lg"><span>${nodes.find(n=>n.id===hist.playerId).name}: ${roleNames[hist.role]}</span><button data-player-id="${hist.playerId}" class="delete-role-hist text-red-400 hover:text-red-300 font-bold text-lg">&times;</button></div>`; }); }
            if (Object.keys(jointTasks).length === 0) { th.innerHTML = createPlaceholder(); }
            else { Object.entries(jointTasks).sort((a,b)=>a[0]-b[0]).forEach(([day, task]) => { th.innerHTML += `<div class="history-item flex justify-between items-center p-3 rounded-lg"><span>Day ${day}: ${nodes.find(n=>n.id===task.p1).name} & ${nodes.find(n=>n.id===task.p2).name} (${task.progress}/3)</span><button data-day="${day}" class="delete-task-hist text-red-400 hover:text-red-300 font-bold text-lg">&times;</button></div>`; }); }
            if (links.length === 0) { teh.innerHTML = createPlaceholder();}
            else { [...links].sort((a,b) => a.day - b.day).forEach(link => { teh.innerHTML += `<div class="history-item flex justify-between items-center p-3 rounded-lg"><span>Day ${link.day}: ${nodes.find(n=>n.id===link.source||n.id===link.source.id).name} → ${nodes.find(n=>n.id===link.target||n.id===link.target.id).name} (${link.type === 'white' ? '白' : '黒'})</span><button data-link-id="${link.id}" class="delete-testimony-hist text-red-400 hover:text-red-300 font-bold text-lg">&times;</button></div>`; }); }
            
            const events = [];
            Object.entries(executions).forEach(([day, data]) => { events.push({day: parseInt(day), type: 'execution', data}); });
            Object.entries(murders).forEach(([day, data]) => { events.push({day: parseInt(day), type: 'murder', data}); });

            if (events.length === 0) { eh.innerHTML = createPlaceholder();}
            else {
                events.sort((a,b) => a.day - b.day).forEach(event => {
                    const player = nodes.find(n => n.id === event.data.playerId);
                    let text, button;
                    if (event.type === 'execution') {
                        let arresterText = '';
                        if(event.data.arresterId) { arresterText = ` (逮捕者: ${nodes.find(n=>n.id===event.data.arresterId).name})`; }
                        text = `Day ${event.day} 吊り: ${player.name} (${event.data.result})${arresterText}`;
                        button = `<button data-day="${event.day}" class="delete-execution-hist text-red-400 hover:text-red-300 font-bold text-lg">&times;</button>`;
                    } else {
                        text = `Day ${event.day} 殺害: ${player.name}`;
                        button = `<button data-day="${event.day}" class="delete-murder-hist text-red-400 hover:text-red-300 font-bold text-lg">&times;</button>`;
                    }
                    eh.innerHTML += `<div class="history-item flex justify-between items-center p-3 rounded-lg"><span>${text}</span>${button}</div>`;
                });
            }
        }
        
        document.getElementById('section-history').addEventListener('click', e => {
            if (e.target.classList.contains('delete-role-hist')) { const id = e.target.dataset.playerId; roleHistory = roleHistory.filter(r => r.playerId !== id); const p = nodes.find(n => n.id === id); if (p) p.role = 'Undetermined'; }
            if (e.target.classList.contains('delete-task-hist')) { delete jointTasks[e.target.dataset.day]; }
            if (e.target.classList.contains('delete-testimony-hist')) { links = links.filter(l => l.id !== parseInt(e.target.dataset.linkId, 10)); }
            if (e.target.classList.contains('delete-execution-hist')) { delete executions[e.target.dataset.day]; }
            if (e.target.classList.contains('delete-murder-hist')) { delete murders[e.target.dataset.day]; }
            updateGraph(); updateHistoryView();
        });
        
        window.addEventListener('resize', () => {
            const newWidth = container.clientWidth;
            svg.attr("width", newWidth).attr("viewBox", [0, 0, newWidth, height]);
            simulation.force("center", d3.forceCenter(newWidth / 2, height / 2)).alpha(0.3).restart();
        });

        updateGraph();
        updateHistoryView();
    });
    </script>
</body>
</html>